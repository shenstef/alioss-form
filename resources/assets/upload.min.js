(function(){var f=function(t,w){var q=document.getElementById(t);var u=100;var y=parseFloat(w/u).toFixed(2);if(y>1){return}q.height=q.height+0;var p=null;if(!q.getContext){return}var x=Math.PI*1.5;var s=(Math.PI*2)*y;p=q.getContext("2d");p.font="16px Arial";p.fillStyle="#ff801a";p.textBaseline="middle";var v=(Number(w/u)*100).toFixed(0)+"%";var r=p.measureText(v).width;p.fillText(v,45-r/2,45);p.save();p.beginPath();p.strokeStyle="#e7e7e7";p.lineWidth="4";p.arc(45,45,30,0,Math.PI*2,false);p.closePath();p.stroke();p.restore();if(w/u===0){return}p.save();p.beginPath();p.strokeStyle="#ff801a";p.lineWidth="4";p.arc(45,45,30,x,(w%u===0?x:(s+x)),false);p.stroke();p.restore();p.save();p.beginPath();p.strokeStyle="#ff801a";p.lineWidth="2";p.strokeRect(0,0,90,90);p.stroke();p.restore()};var b="",o="",d="",j="",e="",n="",c=0,g="",h="";function m(q){var p=timestamp=Date.parse(new Date())/1000;if(c<p+300){$.ajax({url:"/backend/alioss_param",type:"get",dataType:"json",async:false,success:function(r){b=r["accessid"];o=r["host"];d=r["cdn_url"];j=r["policy"];e=r["signature"];c=parseInt(r["expire"]);n=r["dir"];q&&q()},error:function(){alert("抱歉！获取签名错误！")}})}else{q&&q()}}function k(p,q){m(function(){new_multipart_params={"key":n+q,"policy":j,"OSSAccessKeyId":b,"success_action_status":"200","signature":e,};p.setOption({"url":o,"multipart_params":new_multipart_params})})}function a(q){q=q||32;var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";var p=r.length;var s="";for(i=0;i<q;i++){s+=r.charAt(Math.floor(Math.random()*p))}return s}function l(p){var r=p.lastIndexOf(".");var q="";if(r!==-1){q=p.substring(r)}return q.toLowerCase()}window.del_pic=function(s,r){s=$(s);var p="";var q=s.parent();p=q.find("img,a,audio,video").attr("data-filename");q.find("img,a,audio,video").remove();q.find(".upload_add_img").show();q.find("input.Js_upload_input").val("")};window.init_upload=function(v,u,r){var q=$("#"+v);var t=u?$(q.attr("data-warp")):q.parents(".Js_upload_warp");var p=$('<div style="height:0px;width:0px;display:none"></div>').appendTo(t);var s=new plupload.Uploader({runtimes:"html5,flash,silverlight,html4",browse_button:v,container:p.get(0),url:"/backend/upload_file",flash_swf_url:"./plupload-2.1.2/Moxie.swf",silverlight_xap_url:"./plupload-2.1.2/Moxie.xap",multi_selection:u,multipart_params:{"_token":r},filters:{max_file_size:"5gb",mime_types:[{title:"文件",extensions:"gif,jpeg,jpg,png,bmp,text,txt,doc,docx,ppt,pptx,xls,xlsx,pdf,mp3,wav,aac,flac,avi,mov,flv,mp4,3gp"}]},init:{FilesAdded:function(w,x){plupload.each(x,function(y){q.hide();t.prepend('<canvas id="'+y.id+'_canvas" width="90px" height="90px" style="margin-top: 5px;"></canvas>');f(y.id+"_canvas",0)});s.start()},BeforeUpload:function(w,x){h=l(x.name);g=Date.parse(new Date())/1000+"_"+a(10)+h;k(w,g)},UploadProgress:function(w,x){f(x.id+"_canvas",x.percent)},FileUploaded:function(w,y,B){var A=n+g;var x=d+"/"+A;var z=y.type.split("/");$("#"+y.id+"_canvas").remove();switch(z[0]){case"image":t.prepend('<image data-filename="'+A+'" src="'+x+'">').find("input.Js_upload_input").val(A);break;case"video":case"audio":t.prepend('<video controls data-filename="'+A+'" src="'+x+'">您的浏览器不支持 video 标签。</video>').find("input.Js_upload_input").val(A);break;default:t.prepend('<a data-filename="'+A+'" href="'+x+'">'+A+"</a>").find("input.Js_upload_input").val(A);break}},Error:function(w,x){alert("抱歉！出错了："+x.message)}}});s.init()}})();